/////////////////// Plan de recuperación de desastres ///////////////////

DRP (Disaster Recovery Plan) -> Es un conjunto de políticas y procedimientos para recuperar la infraestructura tecnológica y los sistemas vitales después de un desastre natural o provocado por el hombre. Se enfoca en cómo minimizar el tiempo de inactividad y la pérdida de datos.

Hay dos puntos importantes a tener en consideración cuando ocurre un desastre:
RTO (Recovery Time Objective) -> Tiempo máximo tolerable que puede tardar en recuperarse un sistema después de un desastre. (Cuanto tiempo puede estar caído un sistema?)
RPO (Recovery Point Objective) -> Punto máximo en el tiempo al que se puede recuperar un sistema después de un desastre. Mide la cantidad máxima de datos que la empresa está dispuesta a perder. (Cuanto tiempo de datos se puede perder?)
Las estrategias de backup deben responder a estas necesidades, y pueden ser diferentes para cada base de datos.

Hay varios tipos de backup que se pueden utilizar para cumplir con los objetivos de RTO y RPO:
- Full backup           -> Copia completa de la base de datos en un punto en el tiempo.
        -> BACKUP DATABASE [NombreBaseDatos] TO DISK = 'Ruta\NombreBackup.bak' WITH COMPRESSION, STATS = 10;
- Backup de los logs de las transacciones -> Copia de los registros de transacciones desde el último backup *de logs*. Permite la recuperación a un punto específico en el tiempo (Point-in-Time Recovery). Solo disponible en modelos de recuperación FULL o BULK_LOGGED.
        -> BACKUP LOG [NombreBaseDatos] TO DISK = 'Ruta\NombreBackupLog.trn' WITH COMPRESSION, STATS = 10;
- Backup diferencial    -> Copia de los datos que han cambiado desde el último backup completo.
        -> BACKUP DATABASE [NombreBaseDatos] TO DISK = 'Ruta\NombreBackupDiff.dif' WITH DIFFERENTIAL, COMPRESSION, STATS = 10;
- Filegroups backup     -> Copia de uno o más archivos o filegroups de la base de datos. Útil para bases de datos muy grandes, permitiendo respaldar y restaurar partes de la BD de forma independiente.
        -> BACKUP DATABASE [NombreBaseDatos] FILEGROUP = 'NombreFileGroup' TO DISK = 'Ruta\NombreBackupFileGroup.bak' WITH COMPRESSION, STATS = 10;
- Tail-log backup       -> Es un backup del log de transacciones que captura los registros que aún no han sido respaldados. Se realiza justo antes de restaurar una base de datos o cuando está dañada, para evitar la pérdida de trabajo reciente.
        -> BACKUP LOG [NombreBaseDatos] TO DISK = 'Ruta\NombreBackupTailLog.trn' WITH NORECOVERY;

NOTA: Al realizar respaldos de una base de datos, es recomendado guardarlos en diferentes discos, para evitar que si el disco falla, perder toda la información.

Opciones comunes en los comandos de backup:
-- Opciones de gestión de archivos de backup
INIT -> Sobrescribe el archivo de backup si existe, creando un nuevo conjunto de medios. Si no se especifica, el nuevo backup se anexa al archivo (comportamiento por defecto: NOINIT).
NOINIT -> (Predeterminado) Anexa el backup al archivo existente, conservando los backups anteriores en el mismo archivo.

-- Opciones de rendimiento y estado
COMPRESSION -> Realiza el backup comprimiendo los datos, lo que ahorra espacio en disco. Muy recomendado.
STATS = [porcentaje] -> Muestra un mensaje de progreso cada vez que se completa el porcentaje especificado. Por ejemplo, `STATS = 10` muestra el progreso cada 10%.

-- Opciones para backups de log
NORECOVERY -> Se usa principalmente para el 'tail-log backup'. Respalda el final del log y deja la base de datos en estado de restauración (RESTORING), de modo que no se puedan realizar más transacciones antes de la restauración principal.

-- Opciones heredadas (generalmente no necesarias para backups en disco)
-- SKIP -> Omite la verificación de la etiqueta del medio. Usado en backups a cinta.
-- NOREWIND -> No rebobina el medio después del backup. Usado en backups a cinta.
-- NOUNLOAD -> No descarga el medio después del backup. Usado en backups a cinta.

Para crear un respaldo de una base de datos en SSMS sin T-SQL (Transact SQL):
Te diriges al 'Explorador de objetos > Bases de datos > tu_base_de_datos (clic derecho) > Tareas > Copia de seguridad'. Esto abrirá una ventana de configuración del Backup de la base de datos, donde se te permitirá configurar cosas como:
- A que base de datos queremos generarle una copia de seguridad
- El tipo de backup que queremos generar
- Si queremos hacer un Backup de la base de datos o de un grupo de archivos (filegroup)
- La ruta donde queremos guardar la copia (si es en la nube, podemos agregar el URL) (Se pueden agregar varias rutas para crear varias copias)
En la parte izquierda de la ventana, también hay otras opciones como:
- Si quieres sobrescribir todos los conjuntos de copia de seguridad existentes
- Si quieres que se compruebe la copia de seguridad
- Si quieres que tenga fecha de caducidad
- etc.

Estas estrategias deben tomarse en cuenta en el momento que se crea la base de datos, para estar prevenidos en caso de que llegara a ocurrir algún desastre.
Pueden usarse las herramientas propias de SQL Server para el manejo de la recuperación de datos, pero también pueden usarse servicios de terceros.

/////////////////// Proceso de restauración ///////////////////

Se compone de 3 fases
- Realizar la copia de los datos (ya sea completa, diferencial, de logs, etc.)
- Recuperar detalles del registro de transacciones 
- Los datos se ponen al día hasta un punto de recuperación

La restauración de una base de datos implica varios pasos y consideraciones, dependiendo del tipo de backup que se haya realizado y del estado actual de la base de datos.
Hay algunas características que están presentes dependiendo de la versión de SQL Server que se este utilizando (express, developer, enterprise).

SQL Server permite:
- Recuperar grupos de archivos
- Restauración de paginas
- Restauración en línea (Solo en la versión enterprise)

Para realizar la restauración se debe verificar las copias de seguridad a nuestra disposición y validar el estado de las mismas.

Los tipos de restauraciones que permite SQL Server son:
- Restaurar una base de datos
- Remplazar una base de datos existente
- Restaurar archivos de una base de datos existente a una ubicación diferente
- Restaurar una base de datos en modo de espera
- Restauración de una copia de seguridad diferencial
- Restauración de una copia de seguridad del registro de transacciones 

Para verificar si el archivo de respaldo para la recuperacion de la base de datos es valido, podemos hacerlo con esta consulta T-SQL:
	-> RESTORE VERIFYONLY  FROM DISK = N'ruta_del_respaldo.bak'
Una vez que se verifica el estado de la copia, se procede a realizar la restauración:
	-> RESTORE DATABASE nombre_de_la_db  FROM DISK = N'ruta_del_respaldo.bak'
Una vez restaurada, se debe verificar la integridad lógica y física de la base de datos:
	-> DBCC CHECKDB('nombre_de_la_db') 

Para realizar la restauración de la base de datos usando SSMS, creamos primero una base de datos, luego nos dirigimos a: 'Explorador de objetos > Bases de datos > nombre_de_la_db (clic derecho) > Tareas > Restaurar > Base de datos...'.
Esto abrirá una ventana donde podremos configurar la restauración, como que base de datos queremos restaurar, e incluso Comprobar el estado de la copia de seguridad. También hay otras configuraciones, como si se quiere sobrescribir la base de datos.















